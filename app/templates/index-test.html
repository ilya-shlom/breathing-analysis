<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Аудио-рекордер</title>
</head>
<body>
  <h1>Аудио-рекордер</h1>
  <button id="start">Начать запись</button>
  <button id="stop" disabled>Остановить запись</button>
  <button id="send" disabled>Отправить фрагмент</button>
  <audio id="audioPlayback" controls></audio>

  <script>
    let mediaRecorder;
    let audioChunks = [];
    let fullAudioBlob;

    // Запрос доступа к микрофону
    async function initRecorder() {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);

      mediaRecorder.ondataavailable = (event) => {
        audioChunks.push(event.data);
      };

      mediaRecorder.onstop = () => {
        fullAudioBlob = new Blob(audioChunks, { type: 'audio/webm' });
        document.getElementById('audioPlayback').src = URL.createObjectURL(fullAudioBlob);
        audioChunks = [];
      };
    }

    document.getElementById('start').addEventListener('click', () => {
      mediaRecorder.start();
      document.getElementById('stop').disabled = false;
      document.getElementById('send').disabled = false;
    });

    document.getElementById('stop').addEventListener('click', () => {
      mediaRecorder.stop();
      document.getElementById('stop').disabled = true;
      document.getElementById('send').disabled = true;
    });

    document.getElementById('send').addEventListener('click', () => {
      const fragmentBlob = new Blob(audioChunks, { type: 'audio/webm' });
      
      // Отправка фрагмента на сервер
      const formData = new FormData();
      formData.append('audio', fragmentBlob);

      fetch('/upload', { method: 'POST', body: formData })
        .then(response => console.log('Фрагмент отправлен:', response))
        .catch(error => console.error('Ошибка отправки:', error));
    });

    initRecorder();
  </script>
</body>
</html>
